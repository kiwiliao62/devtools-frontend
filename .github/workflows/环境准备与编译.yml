jobs:
  build-all:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: 拉取主仓库+全量子模块（确保单层目录）
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repo-url }}
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.DEVTOOLS_SYNC_TOKEN }}
          submodules: recursive
          path: .

      - name: 配置Git用户信息（gclient必需）
        run: |
          git config --global user.name kiwiliao62
          git config --global user.email qiweiliao@qq.com
          echo "✅ Git身份配置完成"

      # 新增：安装node.js + Python基础依赖
      - name: 安装系统级 node.js + Python 依赖
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs python3-pip python3-setuptools
          node -v && npm -v
          echo "✅ node.js + Python 基础依赖安装完成"

      # 修改：修复depot_tools环境变量（加PYTHONPATH）
      - name: 安装depot_tools（按DEPS配置同步）
        run: |
          if [ ! -d "$DEPOT_PATH" ]; then
            mkdir -p $(dirname $DEPOT_PATH)
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DEPOT_PATH"
          fi
          echo "$GITHUB_WORKSPACE/$DEPOT_PATH" >> $GITHUB_PATH
          echo "PYTHONPATH=$GITHUB_WORKSPACE/$DEPOT_PATH:$PYTHONPATH" >> $GITHUB_ENV
          ls $GITHUB_WORKSPACE/$DEPOT_PATH/node.py || echo "❌ depot_tools node.py 缺失"
          echo "✅ depot_tools路径+PYTHONPATH配置完成"

      # 修改：强制同步depot_tools依赖
      - name: 按DEPS同步所有依赖（核心步骤）
        run: |
          cd $GITHUB_WORKSPACE
          gclient config --unmanaged .
          gclient sync --force --reset --no-history --verbose 2>&1 | tee gclient-sync.log
          if [ -f "$DEPOT_PATH/node.py" ]; then
            echo "✅ depot_tools node.py 存在"
          else
            echo "❌ depot_tools node.py 缺失，同步失败"
            exit 1
          fi
          echo "✅ 按DEPS同步依赖完成"

      # 原有步骤（验证gclient_args.gni、npm安装、gn gen等）...

      # 新增：编译前环境变量兜底
      - name: 编译前环境变量兜底
        run: |
          cd $GITHUB_WORKSPACE
          export PYTHONPATH=$GITHUB_WORKSPACE/$DEPOT_PATH:$PYTHONPATH
          python3 -c "import node; print('✅ node模块导入成功')" || (echo "❌ node模块导入失败" && exit 1)

      # 原有编译步骤...
