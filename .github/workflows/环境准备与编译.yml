name: ä¸€ç«™å¼ç¼–è¯‘æ„å»º_devtools_frontendï¼ˆå…¨äº§ç‰©ä¸Šä¼ ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      repo-url:
        required: true
        type: string
        default: 'kiwiliao62/devtools-frontend'
      branch:
        required: true
        type: string
        default: 'main'

env:
  ARTIFACT_RETENTION_DAYS: 7
  DEPOT_PATH: "third_party/depot_tools"

jobs:
  build-all:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä¸»ä»“åº“+å…¨é‡å­æ¨¡å—ï¼ˆç¡®ä¿å•å±‚ç›®å½•ï¼‰
      - name: æ‹‰å–ä¸»ä»“åº“+å…¨é‡å­æ¨¡å—
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repo-url }}
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.DEVTOOLS_SYNC_TOKEN }}
          submodules: recursive
          path: .

      # æ­¥éª¤2ï¼šé…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆgclientå¿…éœ€ï¼‰
      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name kiwiliao62
          git config --global user.email qiweiliao@qq.com
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆ"

      # æ­¥éª¤3ï¼šå®‰è£…ç³»ç»Ÿçº§ä¾èµ–ï¼ˆåŒ¹é…Codespaceç¯å¢ƒï¼‰
      - name: å®‰è£…ç³»ç»Ÿçº§ä¾èµ–ï¼ˆnode.js/Python/zipï¼‰
        run: |
          # å®‰è£…node.jsï¼ˆå’ŒCodespaceé¢„è£…ç‰ˆæœ¬å¯¹é½ï¼‰
          curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
          # æ›´æ–°æºå¹¶å®‰è£…ä¾èµ–
          sudo apt-get update && sudo apt-get install -y \
            nodejs python3-pip python3-setuptools zip unzip
          # éªŒè¯å®‰è£…ç»“æœ
          node -v && npm -v
          echo "âœ… ç³»ç»Ÿä¾èµ–ï¼ˆnode.js/Python/zipï¼‰å®‰è£…å®Œæˆ"

      # æ­¥éª¤4ï¼šå®‰è£…å¹¶é…ç½®depot_toolsï¼ˆå…³é”®ï¼šå³æ—¶ç”Ÿæ•ˆï¼‰
      - name: å®‰è£…å¹¶é…ç½®depot_tools
        run: |
          # å®šä¹‰depot_toolså®é™…è·¯å¾„
          DEPOT_TOOLS_PATH="$GITHUB_WORKSPACE/$DEPOT_PATH"
          # å…‹éš†depot_toolsï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          if [ ! -d "$DEPOT_TOOLS_PATH" ]; then
            mkdir -p $(dirname $DEPOT_TOOLS_PATH)
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DEPOT_TOOLS_PATH"
          fi
          # 1. ä¸´æ—¶ç”Ÿæ•ˆï¼ˆå½“å‰stepç«‹å³å¯ç”¨ï¼‰
          export PATH="$DEPOT_TOOLS_PATH:$PATH"
          export PYTHONPATH="$DEPOT_TOOLS_PATH:$PYTHONPATH"
          # 2. æ°¸ä¹…ç”Ÿæ•ˆï¼ˆåç»­stepå¯ç”¨ï¼‰
          echo "$DEPOT_TOOLS_PATH" >> $GITHUB_PATH
          echo "PYTHONPATH=$DEPOT_TOOLS_PATH:$PYTHONPATH" >> $GITHUB_ENV
          # éªŒè¯depot_toolsæ ¸å¿ƒæ–‡ä»¶
          which gclient && which gn && which autoninja
          ls -l "$DEPOT_TOOLS_PATH/node.py"
          echo "âœ… depot_toolsé…ç½®å®Œæˆä¸”éªŒè¯é€šè¿‡"

      # æ­¥éª¤5ï¼šæŒ‰DEPSåŒæ­¥æ‰€æœ‰ä¾èµ–ï¼ˆæ ¸å¿ƒï¼‰
      - name: åŒæ­¥gclientä¾èµ–
        run: |
          # æ˜¾å¼åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆå…œåº•ï¼‰
          export PATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PATH"
          export PYTHONPATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PYTHONPATH"
          cd $GITHUB_WORKSPACE
          # é…ç½®gclientå¹¶åŒæ­¥ä¾èµ–
          gclient config --unmanaged .
          gclient sync --force --reset --no-history --verbose 2>&1 | tee gclient-sync.log
          # éªŒè¯ä¾èµ–åŒæ­¥ç»“æœ
          if [ -f "build/config/gclient_args.gni" ]; then
            echo "âœ… gclientä¾èµ–åŒæ­¥å®Œæˆ"
          else
            echo "âŒ ä¾èµ–åŒæ­¥å¤±è´¥ï¼Œæ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi

      # æ­¥éª¤6ï¼šnpmå®‰è£…é¡¹ç›®ä¾èµ–
      - name: npmå®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          cd $GITHUB_WORKSPACE
          npm install --registry=https://registry.npmmirror.com 2>&1 | tee npm-install.log
          echo "âœ… npmä¾èµ–å®‰è£…å®Œæˆ"

      # æ­¥éª¤7ï¼šæ‰§è¡Œgn genï¼ˆæ ‡å‡†é…ç½®ï¼‰
      - name: æ‰§è¡Œgn genç”Ÿæˆæ„å»ºé…ç½®
        run: |
          # æ˜¾å¼åŠ è½½ç¯å¢ƒå˜é‡
          export PATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PATH"
          export PYTHONPATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PYTHONPATH"
          cd $GITHUB_WORKSPACE
          # ç”Ÿæˆæ„å»ºé…ç½®ï¼ˆé€‚é…Runnerèµ„æºé™åˆ¶ï¼‰
          gn gen out/Default --args='
            is_debug=false
            target_os="linux"
            target_cpu="x64"
            enable_ninja_monitor=false
          ' 2>&1 | tee gn-gen.log
          # éªŒè¯é…ç½®ç”Ÿæˆ
          if [ -f "out/Default/build.ninja" ]; then
            echo "âœ… gn gené…ç½®å®Œæˆ"
          else
            echo "âŒ gn genå¤±è´¥ï¼Œæ— build.ninjaæ–‡ä»¶"
            exit 1
          fi

      # æ­¥éª¤8ï¼šç¼–è¯‘å‰ - å­æ¨¡å—ç›®å½•æ‰¹é‡æ‰“åŒ…ä¸Šä¼ 
      - name: éå†å­æ¨¡å—å¹¶æ‰¹é‡æ‰“åŒ…ï¼ˆç¼–è¯‘å‰ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          # è·å–æ‰€æœ‰å­æ¨¡å—è·¯å¾„ï¼ˆå»é‡ã€è¿‡æ»¤ç©ºè¡Œï¼‰
          git submodule foreach --quiet 'echo $path' > submodules-list.txt
          # ä¸ºæ¯ä¸ªå­æ¨¡å—å•ç‹¬æ‰“åŒ…
          while IFS= read -r submodule_path; do
            if [ -n "$submodule_path" ] && [ -d "$submodule_path" ]; then
              # å­æ¨¡å—åï¼ˆæ›¿æ¢è·¯å¾„åˆ†éš”ç¬¦ä¸º-ï¼Œé¿å…å‘½åå†²çªï¼‰
              submodule_name=$(echo "$submodule_path" | tr '/' '-')
              # æ‰“åŒ…å­æ¨¡å—ï¼ˆæ’é™¤.gitç›®å½•ï¼Œå‡å°ä½“ç§¯ï¼‰
              zip -r "submodule-${submodule_name}.zip" "$submodule_path" -x "*/.git/*"
              echo "âœ… å­æ¨¡å—æ‰“åŒ…å®Œæˆï¼šsubmodule-${submodule_name}.zip"
            fi
          done < submodules-list.txt
        if: always()

      - name: ä¸Šä¼ æ‰€æœ‰å­æ¨¡å—åŒ…ï¼ˆç¼–è¯‘å‰ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: submodules-packages
          path: ${{ github.workspace }}/submodule-*.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      # æ­¥éª¤9ï¼šç›®æ ‡æŸ¥è¯¢ï¼ˆç”¨äºåˆ†æï¼‰
      - name: ğŸ” ç›®æ ‡æŸ¥è¯¢ï¼ˆåˆ†æç”¨ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          echo "======================================================"
          echo "ğŸ¯ ç›®æ ‡æŸ¥è¯¢æ—¥å¿—"
          echo "======================================================"
          gn ls out/Default | grep -E "^//:devtools" | sort > devtools-targets.log
          gn ls out/Default | grep -E "devtools_frontend" | sort >> devtools-targets.log
          cat devtools-targets.log
          echo "======================================================"

      # æ­¥éª¤10ï¼šç¼–è¯‘å‰æœ€ç»ˆç¯å¢ƒéªŒè¯ï¼ˆåŒ¹é…Codespaceï¼‰
      - name: ç¼–è¯‘å‰æœ€ç»ˆç¯å¢ƒéªŒè¯
        run: |
          # å®Œå…¨åŒ¹é…Codespaceæ‰§è¡Œæ—¶çš„ç¯å¢ƒ
          export PATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PATH"
          export PYTHONPATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PYTHONPATH"
          # 1. éªŒè¯gn/autoninjaå‘½ä»¤
          which gn && which autoninja
          # 2. éªŒè¯Pythonå¯¼å…¥nodeæ¨¡å—
          python3 -c "import node; print('âœ… nodeæ¨¡å—å¯¼å…¥æˆåŠŸ')"
          # 3. éªŒè¯node.jsç‰ˆæœ¬
          node -v
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå®Œå…¨åŒ¹é…Codespaceï¼Œå‡†å¤‡ç¼–è¯‘"

      # æ­¥éª¤11ï¼šæ‰§è¡Œautoninjaç¼–è¯‘ï¼ˆæ ¸å¿ƒç¼–è¯‘æ­¥éª¤ï¼‰
      - name: æ‰§è¡Œautoninjaç¼–è¯‘
        run: |
          # ä¿æŒç¯å¢ƒå’ŒCodespaceä¸€è‡´
          export PATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PATH"
          export PYTHONPATH="$GITHUB_WORKSPACE/$DEPOT_PATH:$PYTHONPATH"
          cd $GITHUB_WORKSPACE
          echo "======================================================"
          echo "ğŸš€ ç¼–è¯‘æ—¥å¿—"
          echo "======================================================"
          # æ‰§è¡Œç¼–è¯‘å¹¶ä¿ç•™å®Œæ•´æ—¥å¿—
          autoninja -C out/Default :devtools_frontend_resources 2>&1 | tee autoninja-build.log

      # æ­¥éª¤12ï¼šç¼–è¯‘å - front_endæºç å•ç‹¬æ‰“åŒ…ä¸Šä¼ 
      - name: æ‰“åŒ…front_endæºç ç›®å½•ï¼ˆç¼–è¯‘åï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          if [ -d "./front_end" ]; then
            zip -r "source-front_end.zip" ./front_end -x "*/.git/*" "*/node_modules/*"
            echo "âœ… front_endæºç æ‰“åŒ…å®Œæˆï¼šsource-front_end.zip"
          else
            echo "âš ï¸ front_endç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…"
          fi
        if: always()

      - name: ä¸Šä¼ front_endæºç åŒ…ï¼ˆç¼–è¯‘åï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: source-front_end
          path: ${{ github.workspace }}/source-front_end.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      # æ­¥éª¤13ï¼šç¼–è¯‘å - outç¼–è¯‘äº§ç‰©çº¯å‡€æ‰“åŒ…ä¸Šä¼ 
      - name: æ‰“åŒ…outç¼–è¯‘äº§ç‰©ç›®å½•ï¼ˆç¼–è¯‘åï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          if [ -d "./out/Default" ]; then
            # çº¯å‡€æ‰“åŒ…ï¼ˆæ’é™¤ninjaç¼“å­˜ã€ä¸´æ—¶æ–‡ä»¶ï¼‰
            zip -r "compile-out-Default.zip" ./out/Default \
              -x "*/.ninja*" "*/siso*" "*/obj/*" "*/debug_symbols/*"
            echo "âœ… outç¼–è¯‘äº§ç‰©æ‰“åŒ…å®Œæˆï¼šcompile-out-Default.zip"
          else
            echo "âš ï¸ out/Defaultç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…"
          fi
        if: always()

      - name: ä¸Šä¼ outç¼–è¯‘äº§ç‰©åŒ…ï¼ˆç¼–è¯‘åï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: compile-out-Default
          path: ${{ github.workspace }}/compile-out-Default.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      # æ­¥éª¤14ï¼šä¸Šä¼ æ‰€æœ‰è°ƒè¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶åˆ†æç”¨ï¼‰
      - name: ğŸ”´ ä¸Šä¼ æ‰€æœ‰è°ƒè¯•æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: full-debug-logs
          path: |
            out/Default/siso_output
            out/Default/siso.INFO
            out/Default/siso_failed_commands.sh
            gclient-sync.log
            npm-install.log
            gn-gen.log
            autoninja-build.log
            devtools-targets.log
            .gclient
            BUILD.gn
        if: failure()

      # æ­¥éª¤15ï¼šä¸Šä¼ åŸå§‹äº§ç‰©ï¼ˆåˆ†æç”¨ï¼‰
      - name: ä¸Šä¼ äº§ç‰©ï¼ˆåŸå§‹outç›®å½•ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            out/Default/
            !out/Default/*.ninja*
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      # æ­¥éª¤16ï¼šå…¨æµç¨‹ç»“æŸæç¤º
      - name: å…¨æµç¨‹ç»“æŸ
        run: |
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          echo "ğŸ“¦ äº§ç‰©è¯´æ˜ï¼š"
          echo "  - submodules-packagesï¼šæ‰€æœ‰å­æ¨¡å—å•ç‹¬åŒ…ï¼ˆç¼–è¯‘å‰ï¼‰"
          echo "  - source-front_endï¼šfront_endæºç åŒ…ï¼ˆç¼–è¯‘åï¼‰"
          echo "  - compile-out-Defaultï¼šoutç¼–è¯‘äº§ç‰©çº¯å‡€åŒ…ï¼ˆç¼–è¯‘åï¼‰"
          echo "  - full-debug-logsï¼šè°ƒè¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¸Šä¼ ï¼‰"
          echo "  - build-artifactsï¼šåŸå§‹outäº§ç‰©ï¼ˆåˆ†æç”¨ï¼‰"
