name: ä¸€ç«™å¼ç¼–è¯‘æ„å»º_devtools_frontendï¼ˆå…¨äº§ç‰©ä¸Šä¼ ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      repo-url:
        required: true
        type: string
        default: 'kiwiliao62/devtools-frontend'
      branch:
        required: true
        type: string
        default: 'main'
env:
  ARTIFACT_RETENTION_DAYS: 7
  DEPOT_PATH: "third_party/depot_tools"

jobs:
  build-all:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: æ‹‰å–ä¸»ä»“åº“+å…¨é‡å­æ¨¡å—ï¼ˆç¡®ä¿å•å±‚ç›®å½•ï¼‰
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repo-url }}
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.DEVTOOLS_SYNC_TOKEN }}
          submodules: recursive
          path: .

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆgclientå¿…éœ€ï¼‰
        run: |
          git config --global user.name kiwiliao62
          git config --global user.email qiweiliao@qq.com
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆ"

      - name: å®‰è£…depot_toolsï¼ˆæŒ‰DEPSé…ç½®åŒæ­¥ï¼‰
        run: |
          if [ ! -d "$DEPOT_PATH" ]; then
            mkdir -p $(dirname $DEPOT_PATH)
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DEPOT_PATH"
          fi
          echo "$GITHUB_WORKSPACE/$DEPOT_PATH" >> $GITHUB_PATH
          echo "âœ… depot_toolsè·¯å¾„é…ç½®å®Œæˆ"

      - name: æŒ‰DEPSåŒæ­¥æ‰€æœ‰ä¾èµ–ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          gclient config --unmanaged .
          gclient sync --force --no-history --verbose 2>&1 | tee gclient-sync.log
          echo "âœ… æŒ‰DEPSåŒæ­¥ä¾èµ–å®Œæˆ"

      - name: éªŒè¯gclient_args.gniå­˜åœ¨
        run: |
          cd $GITHUB_WORKSPACE
          if [ -f "build/config/gclient_args.gni" ]; then
            echo "âœ… build/config/gclient_args.gni å­˜åœ¨"
          else
            echo "âŒ ä¾èµ–åŒæ­¥å¤±è´¥ï¼Œæ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi

      - name: npmå®‰è£…ä¾èµ–
        run: |
          cd $GITHUB_WORKSPACE
          npm install --registry=https://registry.npmmirror.com 2>&1 | tee npm-install.log
          echo "âœ… npmä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ‰§è¡Œgn genï¼ˆæ ‡å‡†é…ç½®ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          gn gen out/Default --args='
            is_debug=false
            target_os="linux"
            target_cpu="x64"
          ' 2>&1 | tee gn-gen.log
          echo "âœ… gn genæ ‡å‡†é…ç½®å®Œæˆ"

      # ========== æ–°å¢ï¼šç¼–è¯‘å‰ - å­æ¨¡å—ç›®å½•æ‰¹é‡æ‰“åŒ…ä¸Šä¼  ==========
      - name: å®‰è£…zipå·¥å…·ï¼ˆå­æ¨¡å—æ‰“åŒ…å¿…éœ€ï¼‰
        run: sudo apt-get update && sudo apt-get install -y zip
        if: always()

      - name: éå†å­æ¨¡å—å¹¶æ‰¹é‡æ‰“åŒ…ï¼ˆç¼–è¯‘å‰ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          # è·å–æ‰€æœ‰å­æ¨¡å—è·¯å¾„ï¼ˆå»é‡ã€è¿‡æ»¤ç©ºè¡Œï¼‰
          git submodule foreach --quiet 'echo $path' > submodules-list.txt
          # ä¸ºæ¯ä¸ªå­æ¨¡å—å•ç‹¬æ‰“åŒ…
          while IFS= read -r submodule_path; do
            if [ -n "$submodule_path" ] && [ -d "$submodule_path" ]; then
              # å­æ¨¡å—åï¼ˆæ›¿æ¢è·¯å¾„åˆ†éš”ç¬¦ä¸º-ï¼Œé¿å…å‘½åå†²çªï¼‰
              submodule_name=$(echo "$submodule_path" | tr '/' '-')
              # æ‰“åŒ…å­æ¨¡å—ï¼ˆæ’é™¤.gitç›®å½•ï¼Œå‡å°ä½“ç§¯ï¼‰
              zip -r "submodule-${submodule_name}.zip" "$submodule_path" -x "*/.git/*"
              echo "âœ… å­æ¨¡å—æ‰“åŒ…å®Œæˆï¼šsubmodule-${submodule_name}.zip"
            fi
          done < submodules-list.txt
        if: always()

      - name: ä¸Šä¼ æ‰€æœ‰å­æ¨¡å—åŒ…ï¼ˆç¼–è¯‘å‰ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: submodules-packages
          path: ${{ github.workspace }}/submodule-*.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      - name: ğŸ” ç›®æ ‡æŸ¥è¯¢ï¼ˆç”¨äºåˆ†æï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          echo "======================================================"
          echo "ğŸ¯ ç›®æ ‡æŸ¥è¯¢æ—¥å¿—"
          echo "======================================================"
          gn ls out/Default | grep -E "^//:devtools" | sort > devtools-targets.log
          gn ls out/Default | grep -E "devtools_frontend" | sort >> devtools-targets.log
          cat devtools-targets.log
          echo "======================================================"

      - name: æ‰§è¡Œautoninjaç¼–è¯‘ï¼ˆä¼˜å…ˆå…ƒç›®æ ‡ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          echo "======================================================"
          echo "ğŸš€ ç¼–è¯‘æ—¥å¿—"
          echo "======================================================"
          # å°è¯•ç¼–è¯‘å…ƒç›®æ ‡ï¼Œä¿ç•™å®Œæ•´æ—¥å¿—
            autoninja -C out/Default :devtools_frontend_resources
      # ========== æ–°å¢ï¼šç¼–è¯‘å - front_endæºç å•ç‹¬æ‰“åŒ…ä¸Šä¼  ==========
      - name: æ‰“åŒ…front_endæºç ç›®å½•ï¼ˆç¼–è¯‘åï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          if [ -d "./front_end" ]; then
            zip -r "source-front_end.zip" ./front_end -x "*/.git/*" "*/node_modules/*"
            echo "âœ… front_endæºç æ‰“åŒ…å®Œæˆï¼šsource-front_end.zip"
          else
            echo "âš ï¸ front_endç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…"
          fi
        if: always()

      - name: ä¸Šä¼ front_endæºç åŒ…ï¼ˆç¼–è¯‘åï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: source-front_end
          path: ${{ github.workspace }}/source-front_end.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      # ========== æ–°å¢ï¼šç¼–è¯‘å - outç¼–è¯‘äº§ç‰©çº¯å‡€æ‰“åŒ…ä¸Šä¼  ==========
      - name: æ‰“åŒ…outç¼–è¯‘äº§ç‰©ç›®å½•ï¼ˆç¼–è¯‘åï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          if [ -d "./out/Default" ]; then
            # çº¯å‡€æ‰“åŒ…ï¼ˆæ’é™¤ninjaæ–‡ä»¶ã€ä¸´æ—¶ç¼“å­˜ï¼Œä»…ä¿ç•™ç¼–è¯‘äº§ç‰©ï¼‰
            zip -r "compile-out-Default.zip" ./out/Default \
              -x "*/.ninja*" "*/siso*" "*/obj/*" "*/debug_symbols/*"
            echo "âœ… outç¼–è¯‘äº§ç‰©æ‰“åŒ…å®Œæˆï¼šcompile-out-Default.zip"
          else
            echo "âš ï¸ out/Defaultç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…"
          fi
        if: always()

      - name: ä¸Šä¼ outç¼–è¯‘äº§ç‰©åŒ…ï¼ˆç¼–è¯‘åï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: compile-out-Default
          path: ${{ github.workspace }}/compile-out-Default.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      # ========== åŸæœ‰åŠŸèƒ½ä¿ç•™ ==========
      - name: ğŸ”´ ä¸Šä¼ æ‰€æœ‰è°ƒè¯•æ—¥å¿—ï¼ˆå®Œæ•´åˆ†æç”¨ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: full-debug-logs
          path: |
            # SISOæ ¸å¿ƒæ—¥å¿—ï¼ˆç”¨æˆ·æŒ‡å®šï¼‰
            out/Default/siso_output
            out/Default/siso.INFO
            out/Default/siso_failed_commands.sh
            # æµç¨‹æ—¥å¿—ï¼ˆè¡¥å……åˆ†æï¼‰
            gclient-sync.log
            npm-install.log
            gn-gen.log
            autoninja-build.log
            devtools-targets.log
            # é…ç½®æ–‡ä»¶ï¼ˆéªŒè¯ä¸Šä¸‹æ–‡ï¼‰
            .gclient
            BUILD.gn
        if: failure()

      - name: ä¸Šä¼ äº§ç‰©ï¼ˆç”¨äºåˆ†æï¼Œä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            out/Default/
            !out/Default/*.ninja*
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if: always()

      - name: å…¨æµç¨‹ç»“æŸ
        run: |
          echo "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          echo "ğŸ“¦ äº§ç‰©è¯´æ˜ï¼š"
          echo "  - submodules-packagesï¼šæ‰€æœ‰å­æ¨¡å—å•ç‹¬åŒ…ï¼ˆç¼–è¯‘å‰ï¼‰"
          echo "  - source-front_endï¼šfront_endæºç åŒ…ï¼ˆç¼–è¯‘åï¼‰"
          echo "  - compile-out-Defaultï¼šoutç¼–è¯‘äº§ç‰©çº¯å‡€åŒ…ï¼ˆç¼–è¯‘åï¼‰"
          echo "  - full-debug-logsï¼šè°ƒè¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¸Šä¼ ï¼‰"
          echo "  - build-artifactsï¼šåŸå§‹outäº§ç‰©ï¼ˆåˆ†æç”¨ï¼‰"
